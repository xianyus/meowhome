<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ç¥è«­ä¹‹æ›¸ - çµ‚æ¥µè‡ªå‹•åŒ–çµ‚ç«¯</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --border: #334155; --accent: #38bdf8;
            --danger: #f87171; --success: #4ade80; --text: #f1f5f9; --text-muted: #94a3b8; --warning: #fbbf24;
            --hp: #f87171; --mp: #60a5fa; --sp: #34d399;
        }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 10px; line-height: 1.5; }
        .app { max-width: 900px; margin: auto; padding-bottom: 80px; }
        
        .section-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        h3 { font-size: 1rem; color: var(--accent); margin: 0 0 12px 0; border-left: 4px solid var(--accent); padding-left: 8px; }

        .bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; overflow: hidden; margin: 4px 0 10px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease; }
        .hp-fill { background: var(--hp); } .mp-fill { background: var(--mp); } .sp-fill { background: var(--sp); } .exp-fill { background: var(--warning); }

        .status-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            background: rgba(0,0,0,0.2); 
            padding: 10px; 
            border-radius: 8px;
        }
        .status-item { font-size: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; color: var(--text-muted); }
        .status-item input { margin-bottom: 4px; transform: scale(1.1); }

        .header-area { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px; }
        .name-box { flex: 1; min-width: 200px; }
        
        .tabs { display: flex; gap: 4px; margin-bottom: 15px; border-bottom: 1px solid var(--border); }
        .tab { flex: 1; text-align: center; padding: 10px 5px; cursor: pointer; color: var(--text-muted); font-size: 14px; }
        .tab.active { background: var(--accent); color: white; border-radius: 8px 8px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        input, textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px; box-sizing: border-box; font-size: 16px; }
        label { font-size: 11px; color: var(--accent); font-weight: bold; margin-bottom: 4px; display: block; }

        .list-item { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); }
        button { border-radius: 8px; padding: 10px; cursor: pointer; border: 1px solid var(--accent); color: var(--accent); background: transparent; font-size: 14px; }
        .btn-full { width: 100%; margin-top: 10px; }
        .btn-max { background: var(--accent); color: #000; font-weight: bold; border: none; padding: 4px 10px; font-size: 11px; border-radius: 4px; }
        
        .point-banner { background: rgba(56, 189, 248, 0.1); border: 1px dashed var(--accent); padding: 8px; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        #remainPoints { font-size: 1.2rem; font-weight: bold; color: var(--warning); }
        .over-points { color: var(--danger) !important; }

        /* AI å°è©±æ¡†æ¨£å¼ */
        .ai-chat-toggle { position: fixed; bottom: 20px; right: 20px; width: 50px; height: 50px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 24px; }
        .chat-window { position: fixed; bottom: 80px; right: 20px; width: 320px; height: 450px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; display: none; flex-direction: column; z-index: 1000; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .chat-window.active { display: flex; }
        .chat-header { background: var(--accent); color: #000; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-radius: 12px 12px 0 0; }
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.1); }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 85%; font-size: 14px; line-height: 1.4; word-wrap: break-word; }
        .msg.ai { background: var(--border); align-self: flex-start; color: var(--text); }
        .msg.user { background: var(--accent); color: #000; align-self: flex-end; }
        .chat-input-area { padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 8px; }
        .chat-input-area input { flex: 1; padding: 8px; font-size: 14px; border-radius: 6px; }
        .chat-loading { font-size: 12px; color: var(--text-muted); display: none; margin-left: 10px; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="app">
    <div class="section-card" style="padding: 10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <select id="charSelect" onchange="switchCharacter(this.value)" style="flex:1; background:var(--bg); color:white; border:1px solid var(--accent); border-radius:8px; padding:8px;"></select>
            <button onclick="addNewCharacter()" style="margin-left:10px; white-space:nowrap;">ï¼‹æ–°è§’è‰²</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('chars')">è§’è‰²è³‡è¨Š</div>
        <div class="tab" onclick="showTab('world')">ä¸–ç•Œè¨­å®š</div>
        <div class="tab" onclick="showTab('tools')">ç®¡ç†åŒ¯å‡º</div>
    </div>

    <div id="content-chars" class="tab-content active">
        <div class="section-card">
            <div class="header-area">
                <div style="width: 80px; height: 80px; border: 1px solid var(--border); border-radius: 8px; background: #000; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0;" onclick="document.getElementById('avatarInput').click()">
                    <img id="charAvatar" style="display:none; width:100%; height:100%; object-fit:cover;">
                    <span id="avatarHint" style="font-size:10px;">é ­åƒ</span>
                </div>
                <input type="file" id="avatarInput" hidden onchange="uploadAvatar(this)">
                <div class="name-box">
                    <div id="displayName" style="font-size:1.2rem; font-weight:bold; margin-bottom:5px; color:var(--accent);">è§’è‰²å</div>
                    <input data-f="name" oninput="updateUI()" placeholder="è¼¸å…¥åç¨±">
                </div>
            </div>
            
            <div class="grid-stats">
                <div><label>ç­‰ç´š</label><input type="number" data-f="lv" oninput="autoCalc()"></div>
                <div style="grid-column: span 2;">
                    <label>ç¶“é©—å€¼: <span id="expRatio">0/1000</span></label>
                    <input type="number" data-f="exp" oninput="updateExp(this.value)">
                    <div class="bar-bg"><div id="expBar" class="bar-fill exp-fill"></div></div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h3>æ ¸å¿ƒæ•¸å€¼</h3>
            <div class="point-banner">
                <span style="font-size: 11px; color: var(--accent);">å¯ç”¨å‰©é¤˜é»æ•¸</span><br>
                <span id="remainPoints">50</span>
            </div>
            <div class="grid-stats">
                <div><label>HP <span id="maxHP_label"></span></label><input type="number" data-f="hp" oninput="updateBars()" placeholder="--"></div>
                <div><label>MP <span id="maxMP_label"></span></label><input type="number" data-f="mp" oninput="updateBars()" placeholder="--"></div>
                <div><label>SP <span id="maxSP_label"></span></label><input type="number" data-f="sp" oninput="updateBars()" placeholder="--"></div>
            </div>
            <div class="bar-bg"><div id="hpBar" class="bar-fill hp-fill"></div></div>
            <div class="bar-bg"><div id="mpBar" class="bar-fill mp-fill"></div></div>
            <div class="bar-bg"><div id="spBar" class="bar-fill sp-fill"></div></div>
            
            <div class="grid-stats" style="margin-top:10px;">
                <div><label>æ”»æ“ŠåŠ›</label><input type="number" data-f="atk" oninput="calcPoints()" placeholder="--"></div>
                <div><label>é­”æ³•åŠ›</label><input type="number" data-f="mag" oninput="calcPoints()" placeholder="--"></div>
                <div><label>é˜²ç¦¦åŠ›</label><input type="number" data-f="def" oninput="calcPoints()" placeholder="--"></div>
                <div><label>å¹¸é‹</label><input type="number" data-f="luk" oninput="calcPoints()" placeholder="--"></div>
                <div><label>æ„ŸçŸ¥</label><input type="number" data-f="per" oninput="calcPoints()" placeholder="--"></div>
                <div><label>é€Ÿåº¦</label><input type="number" data-f="spd" oninput="calcPoints()" placeholder="--"></div>
            </div>
            <button class="btn-full btn-max" onclick="recoverAll()">MAX å…¨æ¢å¾©</button>
        </div>

        <div class="section-card">
            <h3>æŠ€èƒ½ <button onclick="addItem('abilities')" style="float:right; font-size:10px; padding:2px 5px;">ï¼‹</button></h3>
            <div id="abilities-list"></div>
        </div>
        <div class="section-card">
            <h3>é“å…· <button onclick="addItem('equips')" style="float:right; font-size:10px; padding:2px 5px;">ï¼‹</button></h3>
            <div id="equips-list"></div>
        </div>
    </div>

    <div id="content-world" class="tab-content">
        <div class="section-card">
            <h3>å¤§ä¸–ç•Œç´€éŒ„</h3>
            <textarea id="worldSetting" rows="20" oninput="db.worldContent=this.value;save()"></textarea>
        </div>
    </div>

    <div id="content-tools" class="tab-content">
        <div class="section-card">
            <h3>ç³»çµ±ç®¡ç†</h3>
            <button class="btn-full" onclick="exportJSON()">ä¸‹è¼‰ JSON å‚™ä»½</button>
            <button class="btn-full" onclick="importJSON()">åŒ¯å…¥å‚™ä»½æª”æ¡ˆ</button>
            <button class="btn-full" style="color:var(--danger); border-color:var(--danger); margin-top:20px" onclick="deleteChar()">åˆªé™¤ç•¶å‰è§’è‰²</button>
        </div>
    </div>
</div>

<div class="ai-chat-toggle" onclick="toggleChat()">ğŸ’¬</div>
<div id="chatWindow" class="chat-window">
    <div class="chat-header">
        <span>ğŸ“œ åŠ‡æƒ…å°èˆªå“¡</span>
        <span style="cursor:pointer; font-size: 20px;" onclick="toggleChat()">Ã—</span>
    </div>
    <div id="chatMessages" class="chat-messages">
        <div class="msg ai">å†’éšªè€…ï¼Œæº–å‚™å¥½é–‹å§‹å†’éšªäº†å—ï¼Ÿæˆ‘å·²è¼‰å…¥ä½ çš„è§’è‰²å¡è³‡è¨Šã€‚</div>
    </div>
    <div id="chatLoading" class="chat-loading">AI æ­£åœ¨æ’°å¯«åŠ‡æƒ…...</div>
    <div class="chat-input-area">
        <input type="text" id="chatInput" placeholder="æè¿°ä½ çš„è¡Œå‹•..." onkeypress="if(event.key==='Enter') sendChat()">
        <button onclick="sendChat()" style="background:var(--accent); color:#000; border:none; padding: 5px 12px; font-weight:bold;">ç™¼é€</button>
    </div>
</div>

<script>
// --- åŸæœ‰é‚è¼¯ä¿ç•™ ---
const DB_KEY = "rpg_v11_final";
const API_KEY = "AIzaSyB2v_uPQOH-z0_xe8WdFm45B_gUtn7rvRI"; // ä½ çš„é‡‘é‘°

let db = JSON.parse(localStorage.getItem(DB_KEY)) || {
    currentId: 0, list: [createEmptyChar("æ–°è§’è‰²")], worldContent: ""
};

function createEmptyChar(name) {
    return {
        id: Date.now(), name, lv: 1, exp: "",
        hp: "", mp: "", sp: "", atk: "", mag: "", def: "", luk: "", per: "", spd: "",
        statuses: {}, abilities: [], equips: [], avatar: ""
    };
}
function save() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function getCur() { return db.list[db.currentId]; }

// --- AI å°è©±é‚è¼¯ ---
function toggleChat() { document.getElementById('chatWindow').classList.toggle('active'); }

async function sendChat() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;

    appendMessage('user', text);
    input.value = '';
    document.getElementById('chatLoading').style.display = 'block';

    const cur = getCur();
    const world = db.worldContent || "ä¸€ç‰‡æœªçŸ¥çš„å¥‡å¹»å¤§é™¸";
    
    // æ§‹å»ºè§’è‰²ç‹€æ…‹å­—ä¸²ä¾› AI åƒè€ƒ
    const charStatus = `ç•¶å‰è§’è‰²: ${cur.name}, ç­‰ç´š: ${cur.lv}, HP: ${cur.hp}/${cur.maxHP}, MP: ${cur.mp}/${cur.maxMP}, ä¸–ç•ŒèƒŒæ™¯: ${world}`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [{ text: `ä½ æ˜¯ä¸€ä½ RPG ä¸»æŒäººã€‚è«‹æ ¹æ“šä»¥ä¸‹ç‹€æ…‹æè¿°åŠ‡æƒ…ä¸¦å›æ‡‰ç©å®¶çš„è¡Œå‹•ï¼š\n${charStatus}\nç©å®¶è¡Œå‹•ï¼š${text}` }]
                }]
            })
        });
        const data = await response.json();
        const aiMsg = data.candidates[0].content.parts[0].text;
        appendMessage('ai', aiMsg);
    } catch (e) {
        appendMessage('ai', "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æˆ–ç¶²è·¯ç‹€æ³ã€‚");
    } finally {
        document.getElementById('chatLoading').style.display = 'none';
    }
}

function appendMessage(role, text) {
    const container = document.getElementById('chatMessages');
    const div = document.createElement('div');
    div.className = `msg ${role}`;
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// --- å…¶é¤˜ç³»çµ±åˆå§‹åŒ–é‚è¼¯ ---
function calcPoints() {
    const cur = getCur(); const lv = parseInt(cur.lv) || 1;
    let total = 50; 
    for (let i = 2; i <= lv; i++) {
        if (i <= 10) total += 5; else if (i <= 20) total += 10; else total += 20;
    }
    let used = 0;
    ['atk', 'mag', 'def', 'luk', 'per', 'spd'].forEach(s => {
        const val = parseInt(document.querySelector(`[data-f="${s}"]`).value) || 0;
        cur[s] = document.querySelector(`[data-f="${s}"]`).value;
        used += val;
    });
    const remain = total - used;
    const el = document.getElementById('remainPoints');
    el.textContent = remain;
    el.className = remain < 0 ? 'over-points' : '';
    save();
}

function autoCalc() {
    const cur = getCur(); const lv = parseInt(document.querySelector('[data-f="lv"]').value) || 1;
    cur.lv = lv;
    cur.maxExp = lv * 1000 + (lv-1)*500; cur.maxHP = lv * 20 + 100; cur.maxMP = lv * 10 + 50; cur.maxSP = lv * 10 + 50;
    if(!cur.hp) cur.hp = cur.maxHP; if(!cur.mp) cur.mp = cur.maxMP; if(!cur.sp) cur.sp = cur.maxSP;
    document.getElementById('maxHP_label').textContent = "/ " + cur.maxHP;
    document.getElementById('maxMP_label').textContent = "/ " + cur.maxMP;
    document.getElementById('maxSP_label').textContent = "/ " + cur.maxSP;
    updateExp(cur.exp); updateBars(); calcPoints();
}

function updateBars() {
    const cur = getCur();
    ['hp', 'mp', 'sp'].forEach(f => {
        const val = document.querySelector(`[data-f="${f}"]`).value; cur[f] = val;
        const max = cur['max' + f.toUpperCase()];
        document.getElementById(f + 'Bar').style.width = (max && val) ? Math.min(100, (val / max * 100)) + "%" : "0%";
    });
    save();
}

function updateExp(val) {
    const cur = getCur(); cur.exp = val; const max = cur.maxExp || 1000;
    document.getElementById('expBar').style.width = Math.min(100, (val / max * 100)) + "%";
    document.getElementById('expRatio').textContent = `${val || 0} / ${max}`;
    save();
}

function updateUI() {
    const cur = getCur(); cur.name = document.querySelector('[data-f="name"]').value;
    document.getElementById('displayName').textContent = cur.name;
    if(document.getElementById('charSelect').options[db.currentId]) document.getElementById('charSelect').options[db.currentId].text = cur.name;
    save();
}

function recoverAll() {
    const cur = getCur(); cur.hp = cur.maxHP; cur.mp = cur.maxMP; cur.sp = cur.maxSP;
    document.querySelector('[data-f="hp"]').value = cur.hp; document.querySelector('[data-f="mp"]').value = cur.mp; document.querySelector('[data-f="sp"]').value = cur.sp;
    updateBars(); save();
}

function addItem(type) { getCur()[type].push({n:"", e:""}); renderList(type); save(); }
function renderList(type) {
    const container = document.getElementById(`${type}-list`);
    container.innerHTML = (getCur()[type] || []).map((item, i) => `
        <div class="list-item">
            <input style="flex:2" placeholder="åç¨±" value="${item.n||''}" oninput="getCur().${type}[${i}].n=this.value;save()">
            <textarea style="flex:100%; margin-top:5px;" rows="1" oninput="getCur().${type}[${i}].e=this.value;save()">${item.e||''}</textarea>
            <button style="color:var(--danger); border-color:var(--danger); padding:2px 8px; font-size:10px;" onclick="getCur().${type}.splice(${i},1);renderList('${type}');save()">âœ•</button>
        </div>
    `).join('');
}

function exportJSON() {
    const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "RPG_Backup.json"; a.click();
}

function importJSON() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => { db = JSON.parse(ev.target.result); save(); location.reload(); };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}

function switchCharacter(i) { db.currentId = i; init(); }
function addNewCharacter() { db.list.push(createEmptyChar("æ–°è§’è‰²")); db.currentId = db.list.length-1; init(); }
function deleteChar() { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) { db.list.splice(db.currentId, 1); db.currentId=0; init(); } }
function showTab(t) {
    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('content-' + t).classList.add('active');
}
function uploadAvatar(input) {
    const reader = new FileReader();
    reader.onload = e => { getCur().avatar = e.target.result; renderAvatar(); save(); };
    reader.readAsDataURL(input.files[0]);
}
function renderAvatar() {
    const img = document.getElementById('charAvatar'); const hint = document.getElementById('avatarHint');
    if(getCur().avatar) { img.src = getCur().avatar; img.style.display = "block"; hint.style.display = "none"; }
    else { img.style.display="none"; hint.style.display="block"; }
}

function init() {
    const select = document.getElementById('charSelect');
    select.innerHTML = db.list.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
    select.value = db.currentId;
    const cur = getCur();
    document.querySelectorAll("[data-f]").forEach(el => el.value = cur[el.dataset.f] ?? "");
    document.getElementById('worldSetting').value = db.worldContent || "";
    renderAvatar(); autoCalc(); updateUI(); renderList('abilities'); renderList('equips');
}

init();
</script>
</body>
</html>
