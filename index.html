<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>神諭之書 - 終極自動化終端</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <style>
        :root {
            --bg: #0f172a; --card-bg: #1e293b; --border: #334155; --accent: #38bdf8;
            --danger: #f87171; --success: #4ade80; --text: #f1f5f9; --text-muted: #94a3b8; --warning: #fbbf24;
            --hp: #f87171; --mp: #60a5fa; --sp: #34d399;
        }
        body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 10px; line-height: 1.5; }
        .app { max-width: 900px; margin: auto; }
        
        .section-card { 
            background: var(--card-bg); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        h3 { font-size: 1rem; color: var(--accent); margin: 0 0 12px 0; border-left: 4px solid var(--accent); padding-left: 8px; }

        .bar-bg { width: 100%; height: 6px; background: rgba(0,0,0,0.3); border-radius: 3px; overflow: hidden; margin: 4px 0 10px; }
        .bar-fill { height: 100%; width: 0%; transition: width 0.4s ease; }
        .hp-fill { background: var(--hp); } .mp-fill { background: var(--mp); } .sp-fill { background: var(--sp); } .exp-fill { background: var(--warning); }

        .status-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 8px; 
            background: rgba(0,0,0,0.2); 
            padding: 10px; 
            border-radius: 8px;
        }
        .status-item { font-size: 10px; display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; color: var(--text-muted); }
        .status-item input { margin-bottom: 4px; transform: scale(1.1); }

        .header-area { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px; }
        .name-box { flex: 1; min-width: 200px; }
        
        .tabs { display: flex; gap: 4px; margin-bottom: 15px; border-bottom: 1px solid var(--border); }
        .tab { flex: 1; text-align: center; padding: 10px 5px; cursor: pointer; color: var(--text-muted); font-size: 14px; }
        .tab.active { background: var(--accent); color: white; border-radius: 8px 8px 0 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        
        input, textarea { width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 10px; box-sizing: border-box; font-size: 16px; }
        label { font-size: 11px; color: var(--accent); font-weight: bold; margin-bottom: 4px; display: block; }

        .list-item { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 10px; border: 1px solid var(--border); }
        button { border-radius: 8px; padding: 10px; cursor: pointer; border: 1px solid var(--accent); color: var(--accent); background: transparent; font-size: 14px; }
        .btn-full { width: 100%; margin-top: 10px; }
        .btn-max { background: var(--accent); color: #000; font-weight: bold; border: none; padding: 4px 10px; font-size: 11px; border-radius: 4px; }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-success { border-color: var(--success); color: var(--success); }

        .point-banner { background: rgba(56, 189, 248, 0.1); border: 1px dashed var(--accent); padding: 8px; border-radius: 8px; margin-bottom: 10px; text-align: center; }
        #remainPoints { font-size: 1.2rem; font-weight: bold; color: var(--warning); }
        .over-points { color: var(--danger) !important; }
    </style>
</head>
<body>

<div class="app">
    <div class="section-card" style="padding: 10px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <select id="charSelect" onchange="switchCharacter(this.value)" style="flex:1; background:var(--bg); color:white; border:1px solid var(--accent); border-radius:8px; padding:8px;"></select>
            <button onclick="addNewCharacter()" style="margin-left:10px; white-space:nowrap;">＋新角色</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="showTab('chars')">角色資訊</div>
        <div class="tab" onclick="showTab('world')">世界設定</div>
        <div class="tab" onclick="showTab('tools')">管理匯出</div>
    </div>

    <div id="content-chars" class="tab-content active">
        <div class="section-card">
            <div class="header-area">
                <div style="width: 80px; height: 80px; border: 1px solid var(--border); border-radius: 8px; background: #000; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0;" onclick="document.getElementById('avatarInput').click()">
                    <img id="charAvatar" style="display:none; width:100%; height:100%; object-fit:cover;">
                    <span id="avatarHint" style="font-size:10px;">頭像</span>
                </div>
                <input type="file" id="avatarInput" hidden onchange="uploadAvatar(this)">
                <div class="name-box">
                    <div id="displayName" style="font-size:1.2rem; font-weight:bold; margin-bottom:5px; color:var(--accent);">角色名</div>
                    <input data-f="name" oninput="updateUI()" placeholder="輸入名稱">
                </div>
            </div>
            
            <div class="grid-stats">
                <div><label>等級</label><input type="number" data-f="lv" oninput="autoCalc()"></div>
                <div style="grid-column: span 2;">
                    <label>經驗值: <span id="expRatio">0/1000</span></label>
                    <input type="number" data-f="exp" oninput="updateExp(this.value)">
                    <div class="bar-bg"><div id="expBar" class="bar-fill exp-fill"></div></div>
                </div>
            </div>
        </div>

        <div class="section-card">
            <h3>狀態異常標記</h3>
            <div class="status-grid">
                <label class="status-item"><input type="checkbox" data-s="poison" onchange="updateUI()">中毒</label>
                <label class="status-item"><input type="checkbox" data-s="burn" onchange="updateUI()">燒傷</label>
                <label class="status-item"><input type="checkbox" data-s="freeze" onchange="updateUI()">凍結</label>
                <label class="status-item"><input type="checkbox" data-s="stun" onchange="updateUI()">暈眩</label>
                <label class="status-item"><input type="checkbox" data-s="bleed" onchange="updateUI()">流血</label>
                <label class="status-item"><input type="checkbox" data-s="curse" onchange="updateUI()">詛咒</label>
                <label class="status-item"><input type="checkbox" data-s="blind" onchange="updateUI()">失明</label>
                <label class="status-item"><input type="checkbox" data-s="silence" onchange="updateUI()">沉默</label>
                <label class="status-item"><input type="checkbox" data-s="confuse" onchange="updateUI()">混亂</label>
                <label class="status-item"><input type="checkbox" data-s="stone" onchange="updateUI()">石化</label>
            </div>
        </div>

        <div class="section-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                <h3 style="margin:0;">核心數值</h3>
                <button class="btn-max" onclick="recoverAll()">MAX 全恢復</button>
            </div>

            <div class="point-banner">
                <span style="font-size: 11px; color: var(--accent);">可用剩餘點數</span><br>
                <span id="remainPoints">50</span>
            </div>

            <div class="grid-stats">
                <div><label>HP <span id="maxHP_label"></span></label><input type="number" data-f="hp" oninput="updateBars()" placeholder="--"></div>
                <div><label>MP <span id="maxMP_label"></span></label><input type="number" data-f="mp" oninput="updateBars()" placeholder="--"></div>
                <div><label>SP <span id="maxSP_label"></span></label><input type="number" data-f="sp" oninput="updateBars()" placeholder="--"></div>
            </div>
            <div class="bar-bg"><div id="hpBar" class="bar-fill hp-fill"></div></div>
            <div class="bar-bg"><div id="mpBar" class="bar-fill mp-fill"></div></div>
            <div class="bar-bg"><div id="spBar" class="bar-fill sp-fill"></div></div>
            
            <div class="grid-stats" style="margin-top:10px;">
                <div><label>攻擊力</label><input type="number" data-f="atk" oninput="calcPoints()" placeholder="--"></div>
                <div><label>魔法力</label><input type="number" data-f="mag" oninput="calcPoints()" placeholder="--"></div>
                <div><label>防禦力</label><input type="number" data-f="def" oninput="calcPoints()" placeholder="--"></div>
                <div><label>幸運</label><input type="number" data-f="luk" oninput="calcPoints()" placeholder="--"></div>
                <div><label>感知</label><input type="number" data-f="per" oninput="calcPoints()" placeholder="--"></div>
                <div><label>速度</label><input type="number" data-f="spd" oninput="calcPoints()" placeholder="--"></div>
            </div>
        </div>

        <div class="section-card">
            <h3>技能 (消耗 MP) <button onclick="addItem('abilities')" style="float:right; font-size:10px; padding:2px 5px;">＋</button></h3>
            <div id="abilities-list"></div>
        </div>

        <div class="section-card">
            <h3>裝備與道具 <button onclick="addItem('equips')" style="float:right; font-size:10px; padding:2px 5px;">＋</button></h3>
            <div id="equips-list"></div>
        </div>
    </div>

    <div id="content-world" class="tab-content">
        <div class="section-card">
            <h3>大世界紀錄</h3>
            <textarea id="worldSetting" rows="20" oninput="db.worldContent=this.value;save()"></textarea>
        </div>
    </div>

    <div id="content-tools" class="tab-content">
        <div class="section-card">
            <h3>角色匯出</h3>
            <button class="btn-full" onclick="exportCharWord()">匯出當前角色 (.doc)</button>
            <button class="btn-full" onclick="exportAllCharsWord()">匯出所有角色 (.doc)</button>
        </div>
        <div class="section-card">
            <h3>系統管理</h3>
            <button class="btn-full btn-success" onclick="exportJSON()">下載 JSON 備份</button>
            <button class="btn-full btn-danger" onclick="importJSON()">匯入備份檔案</button>
            <button class="btn-full btn-danger" style="margin-top:20px" onclick="deleteChar()">刪除當前角色</button>
        </div>
    </div>
</div>

<script>
const DB_KEY = "rpg_v11_balanced";
let db = JSON.parse(localStorage.getItem(DB_KEY)) || {
    currentId: 0, list: [createEmptyChar("新角色")], worldContent: ""
};

function createEmptyChar(name) {
    return {
        id: Date.now(), name, lv: 1, exp: "",
        hp: "", mp: "", sp: "", atk: "", mag: "", def: "", luk: "", per: "", spd: "",
        statuses: {}, abilities: [], equips: [], avatar: ""
    };
}

function save() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
function getCur() { return db.list[db.currentId]; }

function calcPoints() {
    const cur = getCur();
    const lv = parseInt(cur.lv) || 1;
    
    // 修改：Lv 1 初始點數上調為 50
    let total = 50; 
    for (let i = 2; i <= lv; i++) {
        if (i <= 10) total += 5;
        else if (i <= 20) total += 10;
        else total += 20;
    }

    const stats = ['atk', 'mag', 'def', 'luk', 'per', 'spd'];
    let used = 0;
    stats.forEach(s => {
        const input = document.querySelector(`[data-f="${s}"]`);
        const val = parseInt(input.value) || 0;
        cur[s] = input.value; // 保留字串形式以支援空值
        used += val;
    });

    const remain = total - used;
    const el = document.getElementById('remainPoints');
    el.textContent = remain;
    el.className = remain < 0 ? 'over-points' : '';
    save();
}

function recoverAll() {
    const cur = getCur();
    cur.hp = cur.maxHP; cur.mp = cur.maxMP; cur.sp = cur.maxSP;
    document.querySelector('[data-f="hp"]').value = cur.hp;
    document.querySelector('[data-f="mp"]').value = cur.mp;
    document.querySelector('[data-f="sp"]').value = cur.sp;
    updateBars(); save();
}

function autoCalc() {
    const cur = getCur();
    const lvInput = document.querySelector('[data-f="lv"]');
    const lv = parseInt(lvInput.value) || 1;
    cur.lv = lv;
    
    cur.maxExp = lv * 1000 + (lv-1)*500; 
    cur.maxHP = lv * 20 + 100;
    cur.maxMP = lv * 10 + 50;
    cur.maxSP = lv * 10 + 50;

    // 修改：切換等級或初始化時，若數值為空，預設填滿 HP/MP/SP
    if(!cur.hp) { cur.hp = cur.maxHP; document.querySelector('[data-f="hp"]').value = cur.hp; }
    if(!cur.mp) { cur.mp = cur.maxMP; document.querySelector('[data-f="mp"]').value = cur.mp; }
    if(!cur.sp) { cur.sp = cur.maxSP; document.querySelector('[data-f="sp"]').value = cur.sp; }

    document.getElementById('maxHP_label').textContent = "/ " + cur.maxHP;
    document.getElementById('maxMP_label').textContent = "/ " + cur.maxMP;
    document.getElementById('maxSP_label').textContent = "/ " + cur.maxSP;
    
    updateExp(cur.exp); updateBars(); calcPoints();
}

function updateBars() {
    const cur = getCur();
    ['hp', 'mp', 'sp'].forEach(f => {
        const input = document.querySelector(`[data-f="${f}"]`);
        const val = input.value;
        cur[f] = val;
        const max = cur['max' + f.toUpperCase()];
        document.getElementById(f + 'Bar').style.width = (max && val) ? Math.min(100, (val / max * 100)) + "%" : "0%";
    });
    save();
}

function updateExp(val) {
    const cur = getCur(); cur.exp = val;
    const max = cur.maxExp || 1000;
    document.getElementById('expBar').style.width = Math.min(100, (val / max * 100)) + "%";
    document.getElementById('expRatio').textContent = `${val || 0} / ${max}`;
    save();
}

function updateUI() {
    const cur = getCur();
    const name = document.querySelector('[data-f="name"]').value;
    cur.name = name;
    document.querySelectorAll('[data-s]').forEach(cb => cur.statuses[cb.dataset.s] = cb.checked);
    document.getElementById('displayName').textContent = name;
    if(document.getElementById('charSelect').options[db.currentId])
        document.getElementById('charSelect').options[db.currentId].text = name;
    save();
}

function renderList(type) {
    const container = document.getElementById(`${type}-list`);
    container.innerHTML = (getCur()[type] || []).map((item, i) => `
        <div class="list-item">
            <input style="flex:2" placeholder="名稱" value="${item.n||''}" oninput="getCur().${type}[${i}].n=this.value;save()">
            ${type==='abilities' ? `<input type="number" style="flex:1" placeholder="MP" value="${item.mp||''}" oninput="getCur().${type}[${i}].mp=this.value;save()">` : ''}
            <textarea style="flex:100%; margin-top:5px;" rows="1" oninput="getCur().${type}[${i}].e=this.value;save()">${item.e||''}</textarea>
            <button class="btn-danger" style="padding:2px 8px; font-size:10px;" onclick="getCur().${type}.splice(${i},1);renderList('${type}');save()">✕</button>
        </div>
    `).join('');
}

function addItem(type) { getCur()[type].push({n:"", e:"", mp:""}); renderList(type); save(); }

function exportCharWord() {
    const c = getCur();
    let html = `<h2>角色卡：${c.name}</h2><p>等級：${c.lv}</p><p>HP: ${c.hp}/${c.maxHP}</p>`;
    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `角色_${c.name}.doc`; link.click();
}

function exportAllCharsWord() {
    let html = db.list.map(c => `<h2>${c.name}</h2><p>LV: ${c.lv}</p>`).join('<hr>');
    const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "全角色.doc"; link.click();
}

function exportJSON() {
    const blob = new Blob([JSON.stringify(db)], {type: "application/json"});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = "RPG_Backup.json"; link.click();
}

function importJSON() {
    const input = document.createElement('input'); input.type = 'file';
    input.onchange = e => {
        const reader = new FileReader();
        reader.onload = ev => { try { db = JSON.parse(ev.target.result); save(); location.reload(); } catch(e) { alert("無效檔案"); } };
        reader.readAsText(e.target.files[0]);
    };
    input.click();
}

function switchCharacter(i) { db.currentId = i; init(); }
function addNewCharacter() { db.list.push(createEmptyChar("新角色")); db.currentId = db.list.length-1; init(); }
function deleteChar() { if(confirm("確定刪除？")) { db.list.splice(db.currentId, 1); db.currentId=0; init(); } }

function showTab(t) {
    document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
    document.getElementById('content-' + t).classList.add('active');
}

function uploadAvatar(input) {
    const reader = new FileReader();
    reader.onload = e => { getCur().avatar = e.target.result; renderAvatar(); save(); };
    reader.readAsDataURL(input.files[0]);
}
function renderAvatar() {
    const img = document.getElementById('charAvatar');
    const hint = document.getElementById('avatarHint');
    if(getCur().avatar) { img.src = getCur().avatar; img.style.display = "block"; hint.style.display = "none"; }
    else { img.style.display="none"; hint.style.display="block"; }
}

function init() {
    const select = document.getElementById('charSelect');
    select.innerHTML = db.list.map((c, i) => `<option value="${i}">${c.name}</option>`).join('');
    select.value = db.currentId;
    const cur = getCur();
    document.querySelectorAll("[data-f]").forEach(el => el.value = cur[el.dataset.f] ?? "");
    document.querySelectorAll("[data-s]").forEach(cb => cb.checked = cur.statuses[cb.dataset.s] || false);
    document.getElementById('worldSetting').value = db.worldContent || "";
    renderAvatar(); autoCalc(); updateUI(); renderList('abilities'); renderList('equips');
}

init();
</script>
</body>
</html>
